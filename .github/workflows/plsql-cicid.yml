name: PL/SQL CI/CD with AI Gate

on:
  push:
    branches:
      - main
    paths:
      - "sql/**"
      - "db/**"
      - "ci/**"

jobs:
  sqlcl_checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Make ci scripts executable
        run: chmod +x ci/run_sqlcl_checks.sh

      - name: Run SQLCL lint & tests
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_CONNECT: ${{ secrets.DB_CONNECT }}
        run: |
          mkdir -p ci
          ./ci/run_sqlcl_checks.sh \
            "$DB_USER" \
            "$DB_PASS" \
            "$DB_CONNECT" \
            "sql" \
            > ci/sqlcl.log 2>&1

      - name: Upload SQLCL logs
        uses: actions/upload-artifact@v4
        with:
          name: sqlcl-logs-${{ github.run_id }}
          path: ci/sqlcl.log

  ai_ci_gate:
    runs-on: ubuntu-latest
    needs: sqlcl_checks

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download SQLCL logs
        uses: actions/download-artifact@v4
        with:
          name: sqlcl-logs-${{ github.run_id }}
          path: ci/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Run AI CI gate on logs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python scripts/ai_ci_gate.py \
            --log-file ci/sqlcl.log \
            --run-id "${{ github.run_id }}-${{ github.run_attempt }}" \
            --output-dir scripts/output-ci

  deploy:
    runs-on: ubuntu-latest
    needs: [sqlcl_checks, ai_ci_gate]
    if: ${{ needs.sqlcl_checks.result == 'success' && needs.ai_ci_gate.result == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Make deploy script executable
        run: chmod +x ci/deploy_sqlcl.sh

      - name: Deploy PL/SQL to target environment
        env:
          DB_USER: ${{ secrets.DEPLOY_DB_USER }}
          DB_PASS: ${{ secrets.DEPLOY_DB_PASS }}
          DB_CONNECT: ${{ secrets.DEPLOY_DB_CONNECT }}
        run: |
          ./ci/deploy_sqlcl.sh \
            "$DB_USER" \
            "$DB_PASS" \
            "$DB_CONNECT" \
            "sql"
